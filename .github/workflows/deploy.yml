name: Trigger Deployment
on:
  push:
    branches:
      - '[0-9]*.[0-9]*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Forge webhook
        run: curl -X POST "${{ secrets.FORGE_WEBHOOK_URL }}"

  merge:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest version branch
        id: latest
        run: |
          LATEST=$(git branch -r | grep -E 'origin/[0-9]+\.[0-9]+' | sed 's/origin\///' | sort -V | tail -1 | tr -d ' ')
          echo "branch=$LATEST" >> $GITHUB_OUTPUT

      - name: Merge into main if latest version
        if: github.ref_name == steps.latest.outputs.branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout main
          git merge origin/${{ github.ref_name }} --no-ff -m "Auto-merge ${{ github.ref_name }} into main"
          git push origin main
